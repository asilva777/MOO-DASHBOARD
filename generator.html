<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Report Generator (MOO Development)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Custom styles for professional feel */
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        .btn-primary {
            background-color: #2563eb;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #1d4ed8;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-4xl mx-auto">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 mb-2">AI-Powered Report Generator</h1>
            <p class="text-lg text-gray-600">Draft professional project reports quickly. The AI will act as the technical writer for the Ormoc City MOO development.</p>
        </header>

        <!-- Input Card -->
        <div class="bg-white p-6 rounded-xl card mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Generate New Report</h2>

            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <!-- Report Type Selector -->
                <div>
                    <label for="reportType" class="block text-sm font-medium text-gray-700 mb-1">Select Report Type / Context</label>
                    <select id="reportType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        <option value="Progress Update">Progress Update (Task Status, Timeline Check)</option>
                        <option value="Financial Justification">Financial Justification (Budget Use, Value-for-Money)</option>
                        <option value="Assessment Summary">Assessment Summary (Key Findings, Next Steps)</option>
                        <option value="Technical Requirement">Technical Requirement Drafting</option>
                        <option value="Custom Report">Custom Report / General Query</option>
                    </select>
                </div>

                <!-- Grounding Selector -->
                <div>
                    <label for="grounding" class="block text-sm font-medium text-gray-700 mb-1">Information Source</label>
                    <select id="grounding" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        <option value="project_context">Project Context (TOR, Proposals, Schedule) & Search</option>
                        <option value="search_only">General Web Search Only</option>
                    </select>
                </div>
            </div>

            <!-- User Prompt -->
            <label for="userPrompt" class="block text-sm font-medium text-gray-700 mb-1">Your Report Prompt / Request</label>
            <textarea id="userPrompt" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-6 transition duration-150"
                      placeholder="e.g., Draft a one-paragraph justification for the PHP 598,500.00 budget, highlighting the value-creation statement."></textarea>

            <button id="generateBtn" class="w-full flex justify-center items-center py-3 px-4 border border-transparent text-base font-medium rounded-lg text-white btn-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150" onclick="generateReport()">
                <span id="btnText">Generate Report</span>
                <div id="loadingIndicator" class="loading-spinner hidden ml-3"></div>
            </button>
        </div>

        <!-- Output Card -->
        <div class="bg-white p-6 rounded-xl card">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Generated Report</h2>
            <div id="reportOutput" class="min-h-40 bg-gray-50 p-4 rounded-lg text-gray-800 whitespace-pre-wrap">
                Your AI-generated report will appear here. Try asking for a progress summary, financial justification, or a key finding from the institutional assessment phase.
            </div>

            <!-- Citations -->
            <div id="citationSection" class="mt-4 pt-4 border-t border-gray-200 hidden">
                <h3 class="text-sm font-semibold text-gray-600 mb-2">Sources Used:</h3>
                <ul id="citationList" class="text-xs text-gray-500 space-y-1">
                    <!-- Citations will be injected here -->
                </ul>
            </div>
        </div>
    </div>

    <script type="module">
        // Global variables for Firebase compatibility (required by environment)
        const __app_id = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
        const __firebase_config = typeof window.__firebase_config !== 'undefined' ? window.__firebase_config : '{}';
        const __initial_auth_token = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : undefined;
        // const firebaseConfig = JSON.parse(__firebase_config);
        
        // --- Gemini API Configuration ---
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const API_KEY = ""; // Canvas environment will inject the key
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
        const MAX_RETRIES = 5;

        // --- Core Project Context (for AI's reference) ---
        // This simulates the AI having access to the documents by providing summarized context in the system prompt.
        const PROJECT_CONTEXT = `
        **Project Context for Ormoc City MOO Development:**
        1. **Objective:** Develop a comprehensive, data-informed Manual of Operations (MOO) for the Emergency Operations Center (EOC) and CDRRMO, aligned with RA 10121, PSCP, and Sendai Framework.
        2. **Budget (ABC):** PHP 598,500.00.
        3. **Key Deliverables/Phases:** Inception Report, Draft MOO, Validation Workshop Report, Final MOO.
        4. **Key Proponent:** Alvin M. Silva, MDM (Lead Consultant).
        5. **Value-Creation Statement (Financial Proposal):** Maximize the budget by prioritizing quality, accountability, and value-for-money, contributing to a functional, resilient, and operationally ready system, advancing institutional continuity, data-driven governance, and public trust.
        6. **Timeline Highlights (Approximate):** Project Start Oct 2025, Assessment Nov 2025, Drafting Nov 2025-Jan 2026, Validation Workshop Jan 2026, Final Submission Feb 2026.
        `;

        /**
         * Converts base64 to ArrayBuffer (required for TTS audio processing, included for completeness).
         * @param {string} base64 The base64 encoded data string.
         * @returns {ArrayBuffer}
         */
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * Implements exponential backoff for API calls.
         * @param {string} apiUrl The API URL.
         * @param {object} payload The request body payload.
         * @param {number} retries The current number of retries.
         * @returns {Promise<Response>}
         */
        async function fetchWithBackoff(apiUrl, payload, retries = 0) {
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.status === 429 && retries < MAX_RETRIES) {
                    const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000;
                    console.warn(`Rate limit hit (429). Retrying in ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithBackoff(apiUrl, payload, retries + 1);
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return response;
            } catch (error) {
                if (retries < MAX_RETRIES) {
                    const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000;
                    console.error(`Fetch failed. Retrying in ${delay / 1000}s.`, error);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithBackoff(apiUrl, payload, retries + 1);
                }
                throw new Error("API call failed after multiple retries.");
            }
        }

        /**
         * Generates the report by calling the Gemini API.
         */
        window.generateReport = async function() {
            const userPrompt = document.getElementById('userPrompt').value.trim();
            const reportType = document.getElementById('reportType').value;
            const groundingMode = document.getElementById('grounding').value;
            const reportOutput = document.getElementById('reportOutput');
            const citationSection = document.getElementById('citationSection');
            const citationList = document.getElementById('citationList');
            const generateBtn = document.getElementById('generateBtn');
            const btnText = document.getElementById('btnText');
            const loadingIndicator = document.getElementById('loadingIndicator');

            if (!userPrompt) {
                reportOutput.innerHTML = '<p class="text-red-500">Please enter a prompt or request for the report.</p>';
                return;
            }

            // UI state: Loading
            btnText.textContent = 'Generating...';
            loadingIndicator.classList.remove('hidden');
            generateBtn.disabled = true;
            reportOutput.innerHTML = '<div class="flex items-center text-blue-500"><div class="loading-spinner !border-t-blue-500 !border-gray-300 mr-3"></div>Drafting the report...</div>';
            citationSection.classList.add('hidden');
            citationList.innerHTML = '';

            try {
                // 1. Define System Instruction and User Query
                const systemInstruction = `
                    You are the expert technical writer and project manager for the Ormoc City Manual of Operations (MOO) development project.
                    Your goal is to generate a professional, concise, and contextually accurate report based on the user's request and the internal project documentation/context provided below.
                    
                    **Tone:** Professional, factual, and proactive.
                    **Task:** Generate a '${reportType}' document.
                    
                    ${PROJECT_CONTEXT}
                    
                    You MUST respond only with the generated report content. Do not include any conversational preamble or postamble.
                `;

                let tools = [];
                if (groundingMode !== 'search_only') {
                     // Add the detailed project context to the system instruction
                     // Note: The system instruction already contains PROJECT_CONTEXT, so we just enable search grounding here.
                }

                if (groundingMode === 'project_context' || groundingMode === 'search_only') {
                    // Enable Google Search grounding for real-time information and citation.
                    tools.push({ "google_search": {} });
                }

                const payload = {
                    contents: [{ parts: [{ text: userPrompt }] }],
                    systemInstruction: { parts: [{ text: systemInstruction }] },
                    tools: tools.length > 0 ? tools : undefined,
                };

                // 2. Make API Call
                const response = await fetchWithBackoff(API_URL, payload);
                const result = await response.json();

                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    reportOutput.innerHTML = text;

                    // 3. Extract grounding sources
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }

                    if (sources.length > 0) {
                        citationSection.classList.remove('hidden');
                        citationList.innerHTML = sources.map((s, index) => 
                            `<li>${index + 1}. <a href="${s.uri}" target="_blank" class="text-blue-600 hover:text-blue-800">${s.title}</a></li>`
                        ).join('');
                    } else {
                        citationSection.classList.add('hidden');
                    }

                } else {
                    reportOutput.innerHTML = '<p class="text-red-500">Error: The AI model returned an empty or unexpected response. Please try a different query.</p>';
                }

            } catch (error) {
                console.error("Report Generation Failed:", error);
                reportOutput.innerHTML = `<p class="text-red-500">A network or API error occurred. Please check your connection or try again later. Error: ${error.message}</p>`;
            } finally {
                // UI state: Ready
                btnText.textContent = 'Generate Report';
                loadingIndicator.classList.add('hidden');
                generateBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
